---
// src/pages/posts/[slug].astro
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
// HeaderはLayout内で読み込んでいるはずなので、ここではLayoutだけでOK！

const { slug } = Astro.params;

const response = await fetch(import.meta.env.WORDPRESS_API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      query GetPostBySlug($id: ID!) {
        post(id: $id, idType: SLUG) {
          title
          content
          date
          featuredImage {
            node {
              sourceUrl
            }
          }
        }
      }
    `,
    variables: { id: slug }
  }),
});

const { data } = await response.json();
const post = data?.post;

if (!post) {
  return Astro.redirect('/404');
}
---

<Layout title={`${post.title} | My Headless Site`}>
  <main class="l-main">
    <article class="p-entry">
      <header class="p-entry__header">
        <div class="p-entry__meta">
          <time class="p-entry__date" datetime={post.date}>
            {new Date(post.date).toLocaleDateString('ja-JP')}
          </time>
        </div>
        <h1 class="p-entry__title">{post.title}</h1>
        
        {post.featuredImage && (
          <div class="p-entry__img">
            <img src={post.featuredImage.node.sourceUrl} alt="" />
          </div>
        )}
      </header>

      {/* 記事本文 */}
      <div class="p-entry__body" set:html={post.content} />
      
      <div class="p-entry__footer">
        <a href="/posts/list" class="c-btn-back">記事一覧へ戻る</a>
      </div>
    </article>
  </main>
</Layout>

<style lang="scss">
.p-entry {
  max-width: 800px;
  margin: 0 auto;
  padding: 60px 20px;

  &__meta {
    margin-bottom: 15px;
  }

  &__date {
    font-size: 0.9rem;
    color: #888;
  }

  &__title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    line-height: 1.3;
    margin-bottom: 30px;
  }

  &__img {
    margin-bottom: 40px;
    img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }
  }

  &__body {
    line-height: 1.9;
    color: #333;
    
    // WordPressから来るHTMLタグへのスタイル設定（:global）
    :global(h2) {
      font-size: 1.75rem;
      margin: 2.5em 0 1em;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }

    :global(h3) {
      font-size: 1.4rem;
      margin: 2em 0 1em;
    }

    :global(p) {
      margin-bottom: 1.8rem;
    }

    :global(img) {
      max-width: 100%;
      height: auto;
      margin: 20px 0;
    }
  }

  &__footer {
    margin-top: 60px;
    padding-top: 40px;
    border-top: 1px solid #eee;
    text-align: center;
  }
}

.c-btn-back {
  display: inline-block;
  padding: 12px 40px;
  background: #333;
  color: #fff;
  text-decoration: none;
  font-size: 0.9rem;
  border-radius: 4px;
  transition: opacity 0.3s;
  &:hover {
    opacity: 0.8;
  }
}
</style>