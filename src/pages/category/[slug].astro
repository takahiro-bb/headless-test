---
// src/pages/category/[slug].astro
import Layout from '../../layouts/Layout.astro';

// 1. URLからカテゴリーのスラッグ（newsなど）を取得
const { slug } = Astro.params;

// 2. GraphQLでそのカテゴリーの情報と、そこに紐づく記事を同時に取得
const response = await fetch(import.meta.env.WORDPRESS_API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      query GetPostsByCategory($slug: ID!) {
        category(id: $slug, idType: SLUG) {
          name
          posts(first: 100) {
            nodes {
              id
              title
              slug
              date
              featuredImage {
                node {
                  sourceUrl
                  altText
                }
              }
            }
          }
        }
      }
    `,
    variables: { slug: slug },
  }),
});

const { data } = await response.json();

// カテゴリーが存在しない場合のガード
const categoryName = data?.category?.name || "Category";
const posts = data?.category?.posts?.nodes || [];

// デバッグ用：取得内容をターミナルで確認（本番公開前に消してOK！）
console.log(`カテゴリー: ${categoryName}, 記事数: ${posts.length}`);
---

<Layout title={`${categoryName} の記事一覧 | My Headless Site`}>
  <main>
    <section class="p-category-head">
      <div class="p-category-head__inner">
        <p class="c-category-sub">Category</p>
        <h1 class="c-title">{categoryName}</h1>
      </div>
    </section>

    <div class="p-post-list-container">
      {posts.length > 0 ? (
        <div class="p-post-list">
          {posts.map((post) => (
            <article class="p-post-card">
              <a href={`/posts/${post.slug}`} class="p-post-card__link">
                <div class="p-post-card__img">
                  {post.featuredImage ? (
                    <img 
                      src={post.featuredImage.node.sourceUrl} 
                      alt={post.featuredImage.node.altText || post.title} 
                    />
                  ) : (
                    <div class="c-no-image">No Image</div>
                  )}
                </div>
                <div class="p-post-card__content">
                  <time class="p-post-card__date">{new Date(post.date).toLocaleDateString()}</time>
                  <h2 class="p-post-card__title">{post.title}</h2>
                </div>
              </a>
            </article>
          ))}
        </div>
      ) : (
        <div class="c-empty-message">
          <p>「{categoryName}」カテゴリーの記事はまだありません。</p>
          <a href="/posts/list" class="c-btn">すべての記事を見る</a>
        </div>
      )}
    </div>
  </main>
</Layout>

<style lang="scss">
.p-category-head {
  background: #f8f9fa;
  padding: 80px 20px;
  text-align: center;
  margin-bottom: 40px;
  &__inner {
    max-width: 800px;
    margin: 0 auto;
  }
}

.c-category-sub {
  font-size: 0.9rem;
  font-weight: 700;
  color: #888;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 10px;
}

.c-title {
  font-size: 2.5rem;
  font-weight: 700;
  color: #333;
}

.p-post-list-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px 80px;
}

.p-post-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 40px;

  .p-post-card {
    border: 1px solid #eee;
    background: #fff;
    transition: transform 0.3s ease;

    &:hover {
      transform: translateY(-5px);
      .p-post-card__img img {
        transform: scale(1.05);
      }
    }

    &__link {
      text-decoration: none;
      color: inherit;
      display: block;
    }
    
    &__img {
      overflow: hidden;
      aspect-ratio: 16 / 9;
      background: #eee;
      img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
      }
    }

    &__content {
      padding: 20px;
    }

    &__date {
      display: block;
      font-size: 0.85rem;
      color: #888;
      margin-bottom: 8px;
    }

    &__title {
      font-size: 1.2rem;
      font-weight: 700;
      line-height: 1.5;
    }
  }
}

.c-empty-message {
  text-align: center;
  padding: 100px 0;
  color: #666;
  .c-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 30px;
    border: 1px solid #333;
    text-decoration: none;
    color: #333;
    transition: all 0.3s;
    &:hover {
      background: #333;
      color: #fff;
    }
  }
}

.c-no-image {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ddd;
  color: #888;
  font-size: 0.8rem;
}
</style>